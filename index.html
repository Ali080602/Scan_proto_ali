<!-- index.html -->
<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QR Gate Scanner</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;margin:0}
#app{display:flex;flex-direction:column;height:100vh}
header{padding:10px;background:#222;color:#fff;text-align:center}
.screen{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column}
.big{font-size:28px;font-weight:700;margin:10px}
.btn{padding:12px 18px;border-radius:8px;border:none;font-size:18px;cursor:pointer}
.green{background:#2ecc71;color:#fff}
.red{background:#e74c3c;color:#fff}
.yellow{background:#f1c40f;color:#000}
#reader{width:320px}
</style>
</head>
<body>
    <div id="app">
<header>QR Gate Scanner</header>
<div id="reader" style="display:flex;justify-content:center;padding:10px"></div>
<div class="screen" id="resultScreen">
<div class="big" id="message">Open camera and scan QR</div>
<div id="details"></div>
<div style="margin-top:12px"><button id="permitBtn" class="btn green" style="display:none">Permitted</button></div>
</div>
</div>
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
<script>
const html5QrCode = new Html5Qrcode("reader");
const qrConfig = { fps: 10, qrbox: {width:250,height:250} };

function setMessage(text, type){
document.getElementById('message').innerText = text;
const btn = document.getElementById('permitBtn');
if(type==='green'){ document.body.style.background = '#dff0dc'; btn.style.display='inline-block'; }
else if(type==='red'){ document.body.style.background = '#ffdede'; btn.style.display='none'; }
else if(type==='yellow'){ document.body.style.background = '#fff8e1'; btn.style.display='none'; }
else { document.body.style.background = '#ffffff'; btn.style.display='none'; }
}

function showDetails(text){ document.getElementById('details').innerText = text; }


function stopScanner(){ html5QrCode.stop().catch(()=>{}); }

function startScanner(){
Html5Qrcode.getCameras().then(cameras => {
const cameraId = (cameras && cameras[0]) ? cameras[0].id : null;
if(!cameraId){ setMessage('No camera found', 'red'); return; }
html5QrCode.start(cameraId, qrConfig, qrCodeMessage => {
// On successful scan
stopScanner();
handleScan(qrCodeMessage);
}, errorMessage => {})
.catch(err=> setMessage('Camera start error: '+err,'red'));
}).catch(err=> setMessage('Camera access error: '+err,'red'));
}

async function handleScan(scannedText){
setMessage('Checking...', 'yellow');
showDetails('Scanned: '+scannedText);
try{
const resp = await google.script.run.withSuccessHandler(handleResponse).processScan(scannedText);
// Note: google.script.run returns asynchronously; handled in callback
}catch(e){ setMessage('Error contacting server','red'); }
}

function handleResponse(res){
// res is the object returned by processScan
if(!res) { setMessage('No response from server','red'); return; }


if(res.status==='not_found'){
setMessage(res.message,'red');
showDetails('ID not found in database');
setTimeout(startScanner,3000);
return;
}

if(res.status==='denied'){
setMessage(res.message,'red');
showDetails('Permission Denied');
setTimeout(startScanner,3000);
return;
}


if(res.status==='allowed_newday' || res.status==='allowed_entry_pending'){
setMessage(res.message,'green');
showDetails('Tap Permitted to record Entry');
const btn = document.getElementById('permitBtn');
btn.style.display='inline-block';
btn.onclick = function(){
btn.disabled = true; btn.innerText='Saving...';
google.script.run.withSuccessHandler(r=>{
setMessage(r.message,'green');
showDetails('Entry saved. You can scan again later for Exit.');
setTimeout(()=>{ btn.disabled=false; btn.innerText='Permitted'; startScanner(); },2500);
}).recordEntry(res.student.Student_ID);
};
return;
}

if(res.status==='exit_recorded'){
setMessage(res.message,'green');
showDetails('Exit time logged');
setTimeout(startScanner,2500);
return;
}


if(res.status==='already_done'){
setMessage(res.message,'yellow');
showDetails('No further action');
setTimeout(startScanner,2500);
return;
}


// Fa
}